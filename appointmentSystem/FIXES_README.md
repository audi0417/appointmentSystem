# 預約系統修正說明

## 問題分析

經過分析發現，預約系統中店家與帳號資訊不一致的主要問題：

1. **資料庫架構不完整**：初始遷移文件缺少 User 模型中定義的商家相關欄位
2. **資料綁定問題**：設定頁面的商家資料沒有與實際的 User 記錄關聯
3. **顯示不同步**：左下角帳號顯示與設定頁面的商家資料可能不一致

## 修正方案

### 1. 資料庫架構修正

- 建立 `scripts/fix_database.py` 修正資料庫架構
- 添加缺少的欄位：email, business_name, avatar_url, phone, address 等
- 確保現有 admin 用戶資料完整

### 2. 後端路由修正

修正 `app/routes/admin.py`：
- `get_settings()` 改為從當前登入用戶讀取資料
- `save_settings()` 改為更新當前登入用戶的資料
- `upload_avatar()` 實際儲存檔案並更新用戶頭像
- 儲存後同步更新 session 中的資訊

### 3. 前端JavaScript修正

修正 `app/static/js/settings.js`：
- 載入設定時從後端API獲取真實資料
- 即時更新左下角顯示名稱
- 儲存時發送到後端API
- 頭像上傳使用實際的檔案上傳

### 4. 帳號初始化修正

修正 `scripts/init_admin.py`：
- 確保創建時所有商家資訊欄位完整
- 檢查並補全現有用戶的缺少欄位
- 提供更詳細的資訊顯示

## 執行步驟

1. **執行資料庫修正**：
   ```bash
   cd appointmentSystem
   python scripts/fix_database.py
   ```

2. **重新初始化管理員**（可選）：
   ```bash
   python scripts/init_admin.py
   ```

3. **重啟應用**：
   ```bash
   python run.py
   ```

## 修正效果

修正後的系統將確保：

1. **資料一致性**：設定頁面的商家名稱與左下角顯示的登入者名稱完全一致
2. **即時同步**：在設定頁面修改商家名稱時，左下角會即時更新顯示
3. **持久化儲存**：所有修改都會真實儲存到資料庫中
4. **頭像同步**：頭像修改會同時更新設定頁面和左下角顯示
5. **完整性驗證**：系統會驗證必填欄位，確保商家資訊完整

## 重要提醒

- 商家基本資料與帳號資訊現在是同一份資料的不同展示
- 任何在設定頁面的修改都會影響整個系統的顯示
- 建議在生產環境使用前先備份資料庫
